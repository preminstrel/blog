<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">

  
  <meta name="author" content="Hanshi Sun">

  
  
  <meta name="description" content="æœ¬æ–‡æ ¸å¿ƒå†…å®¹æ˜¯æŒ‰ç…§æŠ½è±¡åˆ°å…·ä½“æ–¹å¼ï¼Œä»å¤šä¸ªå±‚æ¬¡è¿›è¡Œè®­ç»ƒå’Œæµ‹è¯•æµç¨‹æ·±å…¥è§£æï¼Œä»æœ€æŠ½è±¡å±‚å¼€å§‹ï¼Œåˆ°æœ€åæ ¸å¿ƒä»£ç å®ç°ï¼Œè¿›ä¸€æ­¥ç†è§£ MMDetection å¼€æºæ¡†æ¶æ•´ä½“æ„å»ºç»†èŠ‚">
  

  
  <link rel="icon" href="https://preminstrel.github.io/blog/favicon.ico">

  
  
  <meta name="keywords" content=" hugo  latex  theme ">
  

  
  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css"
  integrity="sha384-KiWOvVjnN8qwAZbuQyWDIbfCLFhLXNETzBQjA/92pIowpC0d2O3nppDGQVgwd2nB" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"
  integrity="sha384-0fdwu/T/EQMsQlrHCCHoH10pkPLlKA1jL5dFyUOvB3lfeT2540/2g6YgSi2BL14p" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/contrib/auto-render.min.js"
  integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR" crossorigin="anonymous"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    renderMathInElement(document.body, {
      delimiters: [
        { left: '$$', right: '$$', display: true },
        { left: '\\[', right: '\\]', display: true },
        { left: '$', right: '$', display: false },
        { left: '\\(', right: '\\)', display: false }
      ],
      ignoredTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code', 'option'],
      throwOnError: false
    });
  });
</script>


  

  
  <meta property="og:title" content="MMDetection Framework" />
<meta property="og:description" content="æœ¬æ–‡æ ¸å¿ƒå†…å®¹æ˜¯æŒ‰ç…§æŠ½è±¡åˆ°å…·ä½“æ–¹å¼ï¼Œä»å¤šä¸ªå±‚æ¬¡è¿›è¡Œè®­ç»ƒå’Œæµ‹è¯•æµç¨‹æ·±å…¥è§£æï¼Œä»æœ€æŠ½è±¡å±‚å¼€å§‹ï¼Œåˆ°æœ€åæ ¸å¿ƒä»£ç å®ç°ï¼Œè¿›ä¸€æ­¥ç†è§£ MMDetection å¼€æºæ¡†æ¶æ•´ä½“æ„å»ºç»†èŠ‚" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://preminstrel.github.io/blog/post/2022/01/16/mmdetection-framework/" />
<meta property="article:published_time" content="2022-01-16T12:42:21+08:00" />
<meta property="article:modified_time" content="2022-01-16T00:00:00+00:00" />


  
  <link rel="canonical" href="https://preminstrel.github.io/blog/post/2022/01/16/mmdetection-framework/">

  
  
  <meta itemprop="name" content="MMDetection Framework">
<meta itemprop="description" content="æœ¬æ–‡æ ¸å¿ƒå†…å®¹æ˜¯æŒ‰ç…§æŠ½è±¡åˆ°å…·ä½“æ–¹å¼ï¼Œä»å¤šä¸ªå±‚æ¬¡è¿›è¡Œè®­ç»ƒå’Œæµ‹è¯•æµç¨‹æ·±å…¥è§£æï¼Œä»æœ€æŠ½è±¡å±‚å¼€å§‹ï¼Œåˆ°æœ€åæ ¸å¿ƒä»£ç å®ç°ï¼Œè¿›ä¸€æ­¥ç†è§£ MMDetection å¼€æºæ¡†æ¶æ•´ä½“æ„å»ºç»†èŠ‚">
<meta itemprop="datePublished" content="2022-01-16T12:42:21&#43;08:00" />
<meta itemprop="dateModified" content="2022-01-16T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="3849">



<meta itemprop="keywords" content="Object Detection,Deep Learning,MMDetection," />

  
  <link media="screen" rel="stylesheet" href='https://preminstrel.github.io/blog/css/common.css'>
  <link media="screen" rel="stylesheet" href='https://preminstrel.github.io/blog/css/content.css'>

  
  
  <title>MMDetection Framework - Blog de Preminstrel</title>
  

  
  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="MMDetection Framework"/>
<meta name="twitter:description" content="æœ¬æ–‡æ ¸å¿ƒå†…å®¹æ˜¯æŒ‰ç…§æŠ½è±¡åˆ°å…·ä½“æ–¹å¼ï¼Œä»å¤šä¸ªå±‚æ¬¡è¿›è¡Œè®­ç»ƒå’Œæµ‹è¯•æµç¨‹æ·±å…¥è§£æï¼Œä»æœ€æŠ½è±¡å±‚å¼€å§‹ï¼Œåˆ°æœ€åæ ¸å¿ƒä»£ç å®ç°ï¼Œè¿›ä¸€æ­¥ç†è§£ MMDetection å¼€æºæ¡†æ¶æ•´ä½“æ„å»ºç»†èŠ‚"/>


  
<link rel="stylesheet" href='https://preminstrel.github.io/blog/css/single.css'>

</head>

<body>
  <div id="wrapper">
    <header id="header">
  <h1>
    <a href="https://preminstrel.github.io/blog/">Blog de Preminstrel</a>
  </h1>

  <nav>
    
    <span class="nav-bar-item">
      <a class="link" href="/blog/">Post</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/blog/post/">Archives</a>
    </span>
    
    <span class="nav-bar-item">
      <a class="link" href="/blog/about/">About</a>
    </span>
    
  </nav>
</header>

    
<main id="main" class="post">
  
  
  <h1>MMDetection Framework</h1>
  
  <div>
    <b>Keywords: </b>
    
    <a class="link" href='https://preminstrel.github.io/blog/tags/object-detection'>#Object Detection</a>
    
    <a class="link" href='https://preminstrel.github.io/blog/tags/deep-learning'>#Deep Learning</a>
    
    <a class="link" href='https://preminstrel.github.io/blog/tags/mmdetection'>#MMDetection</a>
    
  </div>
  
  
  <article class="content">
    
    <p>æœ¬æ–‡æ ¸å¿ƒå†…å®¹æ˜¯<strong>æŒ‰ç…§æŠ½è±¡åˆ°å…·ä½“æ–¹å¼ï¼Œä»å¤šä¸ªå±‚æ¬¡è¿›è¡Œè®­ç»ƒå’Œæµ‹è¯•æµç¨‹æ·±å…¥è§£æ</strong>ï¼Œä»æœ€æŠ½è±¡å±‚å¼€å§‹ï¼Œåˆ°æœ€åæ ¸å¿ƒä»£ç å®ç°ï¼Œè¿›ä¸€æ­¥ç†è§£ MMDetection å¼€æºæ¡†æ¶æ•´ä½“æ„å»ºç»†èŠ‚ã€‚</p>
<h1 id="first-level">First Level</h1>
<div align=center>
<img src="/img/20220116124701.jpg" width="700px"/>
</div>
<p>ä¸Šå›¾ä¸º MMDetection æ¡†æ¶æ•´ä½“è®­ç»ƒå’Œæµ‹è¯•æŠ½è±¡æµç¨‹å›¾ã€‚æŒ‰ç…§æ•°æ®æµè¿‡ç¨‹ï¼Œè®­ç»ƒæµç¨‹å¯ä»¥ç®€å•æ€»ç»“ä¸ºï¼š</p>
<ol>
<li>ç»™å®šä»»ä½•ä¸€ä¸ªæ•°æ®é›†ï¼Œé¦–å…ˆéœ€è¦æ„å»º Dataset ç±»ï¼Œç”¨äºè¿­ä»£è¾“å‡ºæ•°æ®</li>
<li>åœ¨è¿­ä»£è¾“å‡ºæ•°æ®çš„æ—¶å€™éœ€è¦é€šè¿‡æ•°æ® Pipeline å¯¹æ•°æ®è¿›è¡Œå„ç§å¤„ç†ï¼Œæœ€å…¸å‹çš„å¤„ç†æµæ˜¯è®­ç»ƒä¸­çš„<strong class=chinese>æ•°æ®å¢å¼º</strong>æ“ä½œï¼Œæµ‹è¯•ä¸­çš„<strong class=chinese>æ•°æ®é¢„å¤„ç†</strong>ç­‰ç­‰</li>
<li>é€šè¿‡ Sampler é‡‡æ ·å™¨å¯ä»¥æ§åˆ¶ Dataset è¾“å‡ºçš„æ•°æ®é¡ºåºï¼Œæœ€å¸¸ç”¨çš„æ˜¯éšæœºé‡‡æ ·å™¨ <em><strong>RandomSampler</strong></em>ã€‚ç”±äº Dataset ä¸­è¾“å‡ºçš„å›¾ç‰‡å¤§å°ä¸ä¸€æ ·ï¼Œä¸ºäº†å°½å¯èƒ½<strong>å‡å°‘åç»­ç»„æˆ batch æ—¶ pad çš„åƒç´ ä¸ªæ•°</strong>ï¼ŒMM-Detection å¼•å…¥äº†åˆ†ç»„é‡‡æ ·å™¨ GroupSampler å’Œ DistributedGroupSamplerï¼Œç›¸å½“äºåœ¨ RandomSampler åŸºç¡€ä¸Šé¢å¤–æ–°å¢äº†æ ¹æ®å›¾ç‰‡å®½é«˜æ¯”è¿›è¡Œ group åŠŸèƒ½</li>
<li>å°† Sampler å’Œ Dataset éƒ½è¾“å…¥ç»™ DataLoaderï¼Œç„¶åé€šè¿‡ DataLoader è¾“å‡ºå·²ç»„æˆ batch çš„æ•°æ®ï¼Œä½œä¸º Model çš„è¾“å…¥</li>
<li>å¯¹äºä»»ä½•ä¸€ä¸ª Modelï¼Œä¸ºäº†æ–¹ä¾¿å¤„ç†æ•°æ®æµä»¥åŠåˆ†å¸ƒå¼éœ€æ±‚ï¼ŒMMDetection å¼•å…¥äº†ä¸¤ä¸ª Model çš„ä¸Šå±‚å°è£…ï¼šå•æœºç‰ˆæœ¬ MMDataParallelã€åˆ†å¸ƒå¼ï¼ˆå•æœºå¤šå¡æˆ–å¤šæœºå¤šå¡ï¼‰ç‰ˆæœ¬ MMDistributedDataParallel</li>
<li>Model è¿è¡Œåä¼šè¾“å‡º loss ä»¥åŠå…¶ä»–ä¸€äº›ä¿¡æ¯ï¼Œä¼šé€šè¿‡ <em><strong>logger</strong></em> è¿›è¡Œä¿å­˜æˆ–è€…å¯è§†åŒ–</li>
<li>ä¸ºäº†æ›´å¥½åœ°è§£è€¦ï¼Œ æ–¹ä¾¿åœ°è·å–å„ä¸ªç»„ä»¶ä¹‹é—´ä¾èµ–å’Œçµæ´»æ‰©å±•ï¼ŒMMDetection å¼•å…¥äº† <em><strong>Runner</strong></em> ç±»è¿›è¡Œå…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œå¹¶ä¸”<strong>é€šè¿‡ Hook æ–¹ä¾¿çš„è·å–ã€ä¿®æ”¹å’Œæ‹¦æˆªä»»ä½•ç”Ÿå‘½å‘¨æœŸæ•°æ®æµ</strong>ï¼Œæ‰©å±•éå¸¸ä¾¿æ·</li>
</ol>
<p>è€Œæµ‹è¯•æµç¨‹å°±æ¯”è¾ƒç®€å•äº†ï¼Œç›´æ¥å¯¹ DataLoader è¾“å‡ºçš„æ•°æ®è¿›è¡Œå‰å‘æ¨ç†å³å¯ï¼Œè¿˜åŸåˆ°æœ€ç»ˆåŸå›¾å°ºåº¦è¿‡ç¨‹ä¹Ÿæ˜¯åœ¨ Model ä¸­å®Œæˆã€‚</p>
<p>ä»¥ä¸Šå°±æ˜¯ MMDetection æ¡†æ¶æ•´ä½“è®­ç»ƒå’Œæµ‹è¯•æŠ½è±¡æµç¨‹ï¼Œä¸Šå›¾ä¸ä»…ä»…åæ˜ äº†è®­ç»ƒå’Œæµ‹è¯•æ•°æ®æµï¼Œè€Œä¸”è¿˜åŒ…æ‹¬äº†æ¨¡å—å’Œæ¨¡å—ä¹‹é—´çš„è°ƒç”¨å…³ç³»ã€‚å¯¹äºè®­ç»ƒè€Œè¨€ï¼Œæœ€æ ¸å¿ƒéƒ¨åˆ†åº”è¯¥æ˜¯ Runnerï¼Œç†è§£äº† Runner çš„è¿è¡Œæµç¨‹ï¼Œä¹Ÿå°±ç†è§£äº†æ•´ä¸ª MMDetection æ•°æ®æµã€‚</p>
<h1 id="second-level">Second Level</h1>
<p>åœ¨æ€»ä½“æŠŠæ¡äº†æ•´ä¸ª MMDetection æ¡†æ¶è®­ç»ƒå’Œæµ‹è¯•æµç¨‹åï¼Œä¸‹ä¸ªå±‚æ¬¡æ˜¯æ¯ä¸ªæ¨¡å—å†…éƒ¨æŠ½è±¡æµç¨‹ï¼Œä¸»è¦åŒ…æ‹¬ Pipelineã€DataParallelã€Modelã€Runner å’Œ Hooksã€‚</p>
<h2 id="pipeline">Pipeline</h2>
<p>Pipeline å®é™…ä¸Šç”±ä¸€ç³»åˆ—æŒ‰ç…§æ’å…¥é¡ºåºè¿è¡Œçš„æ•°æ®å¤„ç†æ¨¡å—ç»„æˆï¼Œæ¯ä¸ªæ¨¡å—å®ŒæˆæŸä¸ªç‰¹å®šåŠŸèƒ½ï¼Œä¾‹å¦‚ Resizeï¼Œå› ä¸ºå…¶æµå¼é¡ºåºè¿è¡Œç‰¹æ€§ï¼Œæ•…å«åš Pipelineã€‚</p>
<div align=center>
<img src="/img/20220116130000.jpg" width="800px"/>
</div>
<p>ä¸Šå›¾æ˜¯ä¸€ä¸ªéå¸¸å…¸å‹çš„è®­ç»ƒæµç¨‹ Pipelineï¼Œæ¯ä¸ªç±»éƒ½æ¥æ”¶å­—å…¸è¾“å…¥ï¼Œè¾“å‡ºä¹Ÿæ˜¯å­—å…¸ï¼Œé¡ºåºæ‰§è¡Œï¼Œå…¶ä¸­<strong>ç»¿è‰²è¡¨ç¤ºè¯¥ç±»è¿è¡Œåæ–°å¢å­—æ®µï¼Œæ©™è‰²è¡¨ç¤ºå¯¹è¯¥å­—æ®µå¯èƒ½ä¼šè¿›è¡Œä¿®æ”¹</strong>ã€‚å¦‚æœè¿›ä¸€æ­¥ç»†åˆ†çš„è¯ï¼Œä¸åŒç®—æ³•çš„ Pipeline éƒ½å¯ä»¥åˆ’åˆ†ä¸ºå¦‚ä¸‹éƒ¨åˆ†ï¼š</p>
<ul>
<li><strong class=chinese>å›¾ç‰‡å’Œæ ‡ç­¾åŠ è½½</strong>ï¼Œé€šå¸¸ç”¨çš„ç±»æ˜¯ LoadImageFromFile å’Œ LoadAnnotations</li>
<li><strong class=chinese>æ•°æ®å‰å¤„ç†</strong>ï¼Œä¾‹å¦‚ç»Ÿä¸€ Resize</li>
<li><strong class=chinese>æ•°æ®å¢å¼º</strong>ï¼Œå…¸å‹çš„ä¾‹å¦‚å„ç§å›¾ç‰‡å‡ ä½•å˜æ¢ç­‰ï¼Œè¿™éƒ¨åˆ†æ˜¯è®­ç»ƒæµç¨‹ç‰¹æœ‰ï¼Œæµ‹è¯•é˜¶æ®µä¸€èˆ¬ä¸é‡‡ç”¨(å¤šå°ºåº¦æµ‹è¯•é‡‡ç”¨å…¶ä»–å®ç°æ–¹å¼)</li>
<li><strong class=chinese>æ•°æ®æ”¶é›†</strong>ï¼Œä¾‹å¦‚ Collect</li>
</ul>
<p>åœ¨ MMDetection æ¡†æ¶ä¸­ï¼Œå›¾ç‰‡å’Œæ ‡ç­¾åŠ è½½å’Œæ•°æ®åå¤„ç†æµç¨‹ä¸€èˆ¬æ˜¯å›ºå®šçš„ï¼Œç”¨æˆ·ä¸»è¦å¯èƒ½ä¿®æ”¹çš„æ˜¯æ•°æ®å¢å¼ºæ­¥éª¤ï¼Œç›®å‰å·²ç»æ¥å…¥äº†ç¬¬ä¸‰æ–¹å¢å¼ºåº“ Albumentationsï¼Œå¯ä»¥æŒ‰ç…§ç¤ºä¾‹ä»£ç è½»æ¾æ„å»ºå±äºä½ è‡ªå·±çš„æ•°æ®å¢å¼º Pipelineã€‚</p>
<p><strong>åœ¨æ„å»ºè‡ªå·±çš„ Pipeline æ—¶å€™ä¸€å®šè¦ä»”ç»†æ£€æŸ¥ä¿®æ”¹æˆ–è€…æ–°å¢çš„å­—å…¸ key å’Œ valueï¼Œå› ä¸ºä¸€æ—¦é”™è¯¯åœ°è¦†ç›–æˆ–è€…ä¿®æ”¹åŸå…ˆå­—å…¸é‡Œé¢çš„å†…å®¹ï¼Œä»£ç ä¹Ÿå¯èƒ½ä¸ä¼šæŠ¥é”™ï¼Œå¦‚æœå‡ºç° bugï¼Œåˆ™æ¯”è¾ƒéš¾æ’æŸ¥</strong>ã€‚</p>
<h2 id="dataparallel--model">DataParallel &amp; Model</h2>
<p>åœ¨ MMDetection ä¸­ DataLoader è¾“å‡ºçš„å†…å®¹<strong>ä¸æ˜¯ PyTorch èƒ½å¤„ç†çš„æ ‡å‡†æ ¼å¼</strong>ï¼Œè¿˜åŒ…æ‹¬äº† <em><strong>DataContainer</strong></em> å¯¹è±¡ï¼Œè¯¥å¯¹è±¡çš„ä½œç”¨æ˜¯åŒ…è£…ä¸åŒç±»å‹çš„å¯¹è±¡ä½¿ä¹‹èƒ½æŒ‰éœ€ç»„æˆ batchã€‚åœ¨ç›®æ ‡æ£€æµ‹ä¸­ï¼Œæ¯å¼ å›¾ç‰‡ gt bbox ä¸ªæ•°æ˜¯ä¸ä¸€æ ·çš„ï¼Œå¦‚æœæƒ³ç»„æˆ batch tensorï¼Œè¦ä¹ˆä½ è®¾ç½®æœ€å¤§é•¿åº¦ï¼Œè¦ä¹ˆä½ è‡ªå·±æƒ³åŠæ³•ç»„æˆ batchã€‚è€Œè€ƒè™‘åˆ°å†…å­˜å’Œæ•ˆç‡ï¼ŒMMDetection é€šè¿‡å¼•å…¥ DataContainer æ¨¡å—æ¥è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œä½†æ˜¯éšä¹‹å¸¦æ¥çš„é—®é¢˜æ˜¯ PyTorch æ— æ³•è§£æ DataContainer å¯¹è±¡ï¼Œæ•…éœ€è¦åœ¨ MMDetection ä¸­è‡ªè¡Œå¤„ç†ã€‚</p>
<p>è§£å†³åŠæ³•å…¶å®éå¸¸å¤šï¼ŒMMDetection é€‰æ‹©äº†ä¸€ç§æ¯”è¾ƒä¼˜é›…çš„å®ç°æ–¹å¼ï¼šMMDataParallel å’Œ MMDistributed-DataParallelã€‚å…·ä½“æ¥è¯´ï¼Œè¿™ä¸¤ä¸ªç±»ç›¸æ¯” PyTorch è‡ªå¸¦çš„ DataParallel å’Œ DistributedDataParallel åŒºåˆ«æ˜¯ï¼š</p>
<ul>
<li>å¯ä»¥å¤„ç† DataContainer å¯¹è±¡</li>
<li>é¢å¤–å®ç°äº† <code>train_step()</code> å’Œ <code>val_step()</code> ä¸¤ä¸ªå‡½æ•°ï¼Œå¯ä»¥è¢« Runner è°ƒç”¨</li>
</ul>
<p>å…³äºè¿™ä¸¤ä¸ªç±»çš„å…·ä½“å®ç°åé¢ä¼šæè¿°ã€‚</p>
<h2 id="runner-å’Œ-hooks">Runner å’Œ Hooks</h2>
<p>å¯¹äºä»»ä½•ä¸€ä¸ªç›®æ ‡æ£€æµ‹ç®—æ³•ï¼Œéƒ½éœ€è¦åŒ…æ‹¬<strong>ä¼˜åŒ–å™¨ã€å­¦ä¹ ç‡è®¾ç½®ã€æƒé‡ä¿å­˜</strong>ç­‰ç­‰ç»„ä»¶æ‰èƒ½æ„æˆå®Œæ•´è®­ç»ƒæµç¨‹ï¼Œè€Œè¿™äº›ç»„ä»¶æ˜¯é€šç”¨çš„ã€‚ä¸ºäº†æ–¹ä¾¿ OpenMMLab ä½“ç³»ä¸‹çš„æ‰€æœ‰æ¡†æ¶å¤ç”¨ï¼Œåœ¨ MMCV æ¡†æ¶ä¸­å¼•å…¥äº† Runner ç±»æ¥ç»Ÿä¸€ç®¡ç†è®­ç»ƒå’ŒéªŒè¯æµç¨‹ï¼Œå¹¶ä¸”é€šè¿‡ Hooks æœºåˆ¶ä»¥ä¸€ç§éå¸¸çµæ´»ã€è§£è€¦çš„æ–¹å¼æ¥å®ç°ä¸°å¯Œæ‰©å±•åŠŸèƒ½ã€‚</p>
<p>å…³äº Runner å’Œ Hooks è¯¦ç»†è§£è¯»ä¼šå‘å¸ƒåœ¨ MMCV ç³»åˆ—è§£è¯»æ–‡ç« ä¸­ï¼Œç®€å•æ¥è¯´ <strong>Runner å°è£…äº† OpenMMLab ä½“ç³»ä¸‹å„ä¸ªæ¡†æ¶çš„è®­ç»ƒå’ŒéªŒè¯è¯¦ç»†æµç¨‹ï¼Œå…¶è´Ÿè´£ç®¡ç†è®­ç»ƒå’ŒéªŒè¯è¿‡ç¨‹ä¸­çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œé€šè¿‡é¢„å®šä¹‰å›è°ƒå‡½æ•°ï¼Œç”¨æˆ·å¯ä»¥æ’å…¥å®šåˆ¶åŒ– Hook ï¼Œä»è€Œå®ç°å„ç§å„æ ·çš„éœ€æ±‚</strong>ã€‚ä¸‹é¢åˆ—å‡ºäº†åœ¨ MMDetection å‡ ä¸ªéå¸¸é‡è¦çš„ hook ä»¥åŠå…¶ä½œç”¨çš„ç”Ÿå‘½å‘¨æœŸï¼š</p>
<div align=center>
<img src="/img/20220116131700.jpg" width="600px"/>
</div>
<p>ä¾‹å¦‚ CheckpointHook åœ¨æ¯ä¸ªè®­ç»ƒ epoch å®Œæˆåä¼šè¢«è°ƒç”¨ï¼Œä»è€Œå®ç°ä¿å­˜æƒé‡åŠŸèƒ½ã€‚ç”¨æˆ·ä¹Ÿå¯ä»¥å°†è‡ªå·±å®šåˆ¶å®ç°çš„ Hook é‡‡ç”¨ä¸Šè¿°æ–¹å¼ç»˜åˆ¶ï¼Œå¯¹ç†è§£æ•´ä¸ªæµç¨‹æˆ–è®¸æœ‰å¸®åŠ©ã€‚</p>
<h1 id="third-level">Third Level</h1>
<p>å‰é¢ä¸¤å±‚æŠ½è±¡åˆ†ææµç¨‹ï¼ŒåŸºæœ¬ä¸ŠæŠŠæ•´ä¸ª MMDetection çš„è®­ç»ƒå’Œæµ‹è¯•æµç¨‹åˆ†æå®Œäº†ï¼Œä¸‹é¢ä»å…·ä½“ä»£ç å±‚é¢è¿›è¡ŒæŠ½è±¡åˆ†æã€‚</p>
<h2 id="train--test">Train &amp; Test</h2>
<div align=center>
<img src="/img/20220116131900.jpg" width="600px"/>
</div>
ä¸Šå›¾ä¸ºè®­ç»ƒå’ŒéªŒè¯çš„å’Œå…·ä½“ä»£ç ç›¸å…³çš„æ•´ä½“æŠ½è±¡æµç¨‹ï¼Œå¯¹åº”åˆ°ä»£ç ä¸Šï¼Œå…¶æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#080;font-style:italic">#=================== tools/train.py ==================</span>
<span style="color:#080;font-style:italic"># 1.åˆå§‹åŒ–é…ç½®</span>
cfg <span style="color:#666">=</span> Config<span style="color:#666">.</span>fromfile(args<span style="color:#666">.</span>config)

<span style="color:#080;font-style:italic"># 2.åˆ¤æ–­æ˜¯å¦ä¸ºåˆ†å¸ƒå¼è®­ç»ƒæ¨¡å¼</span>

<span style="color:#080;font-style:italic"># 3.åˆå§‹åŒ– logger</span>
logger <span style="color:#666">=</span> get_root_logger(log_file<span style="color:#666">=</span>log_file, log_level<span style="color:#666">=</span>cfg<span style="color:#666">.</span>log_level)

<span style="color:#080;font-style:italic"># 4.æ”¶é›†è¿è¡Œç¯å¢ƒå¹¶ä¸”æ‰“å°ï¼Œæ–¹ä¾¿æ’æŸ¥ç¡¬ä»¶å’Œè½¯ä»¶ç›¸å…³é—®é¢˜</span>
env_info_dict <span style="color:#666">=</span> collect_env()

<span style="color:#080;font-style:italic"># 5.åˆå§‹åŒ– model</span>
model <span style="color:#666">=</span> build_detector(cfg<span style="color:#666">.</span>model, <span style="color:#666">...</span>)

<span style="color:#080;font-style:italic"># 6.åˆå§‹åŒ– datasets</span>

<span style="color:#080;font-style:italic">#=================== mmdet/apis/train.py ==================</span>
<span style="color:#080;font-style:italic"># 1.åˆå§‹åŒ– data_loaders ï¼Œå†…éƒ¨ä¼šåˆå§‹åŒ– GroupSampler</span>
data_loader <span style="color:#666">=</span> DataLoader(dataset,<span style="color:#666">...</span>)

<span style="color:#080;font-style:italic"># 2.åŸºäºæ˜¯å¦ä½¿ç”¨åˆ†å¸ƒå¼è®­ç»ƒï¼Œåˆå§‹åŒ–å¯¹åº”çš„ DataParallel</span>
<span style="color:#a2f;font-weight:bold">if</span> distributed:
  model <span style="color:#666">=</span> MMDistributedDataParallel(<span style="color:#666">...</span>)
<span style="color:#a2f;font-weight:bold">else</span>:
  model <span style="color:#666">=</span> MMDataParallel(<span style="color:#666">...</span>)

<span style="color:#080;font-style:italic"># 3.åˆå§‹åŒ– runner</span>
runner <span style="color:#666">=</span> EpochBasedRunner(<span style="color:#666">...</span>)

<span style="color:#080;font-style:italic"># 4.æ³¨å†Œå¿…å¤‡ hook</span>
runner<span style="color:#666">.</span>register_training_hooks(cfg<span style="color:#666">.</span>lr_config, optimizer_config,
                               cfg<span style="color:#666">.</span>checkpoint_config, cfg<span style="color:#666">.</span>log_config,
                               cfg<span style="color:#666">.</span>get(<span style="color:#b44">&#39;momentum_config&#39;</span>, None))

<span style="color:#080;font-style:italic"># 5.å¦‚æœéœ€è¦ valï¼Œåˆ™è¿˜éœ€è¦æ³¨å†Œ EvalHook           </span>
runner<span style="color:#666">.</span>register_hook(eval_hook(val_dataloader, <span style="color:#666">**</span>eval_cfg))

<span style="color:#080;font-style:italic"># 6.æ³¨å†Œç”¨æˆ·è‡ªå®šä¹‰ hook</span>
runner<span style="color:#666">.</span>register_hook(hook, priority<span style="color:#666">=</span>priority)

<span style="color:#080;font-style:italic"># 7.æƒé‡æ¢å¤å’ŒåŠ è½½</span>
<span style="color:#a2f;font-weight:bold">if</span> cfg<span style="color:#666">.</span>resume_from:
    runner<span style="color:#666">.</span>resume(cfg<span style="color:#666">.</span>resume_from)
<span style="color:#a2f;font-weight:bold">elif</span> cfg<span style="color:#666">.</span>load_from:
    runner<span style="color:#666">.</span>load_checkpoint(cfg<span style="color:#666">.</span>load_from)

<span style="color:#080;font-style:italic"># 8.è¿è¡Œï¼Œå¼€å§‹è®­ç»ƒ</span>
runner<span style="color:#666">.</span>run(data_loaders, cfg<span style="color:#666">.</span>workflow, cfg<span style="color:#666">.</span>total_epochs)
</code></pre></div><p>ä¸Šé¢çš„æµç¨‹æ¯”è¾ƒç®€å•ï¼Œä¸€èˆ¬å¤§å®¶æ¯”è¾ƒéš¾ä»¥ç†è§£çš„æ˜¯ <code>runner.run</code> å†…éƒ¨é€»è¾‘ï¼Œä¸‹å°èŠ‚è¿›è¡Œè¯¦ç»†åˆ†æï¼Œè€Œå¯¹äºæµ‹è¯•é€»è¾‘ç”±äºæ¯”è¾ƒç®€å•ï¼Œå°±ä¸è¯¦ç»†æè¿°äº†ï¼Œç®€å•æ¥è¯´æµ‹è¯•æµç¨‹ä¸‹ä¸éœ€è¦ runnerï¼Œç›´æ¥åŠ è½½è®­ç»ƒå¥½çš„æƒé‡ï¼Œç„¶åè¿›è¡Œ model æ¨ç†å³å¯ã€‚</p>
<h2 id="runner">Runner</h2>
<p>runner å¯¹è±¡å†…éƒ¨çš„ run æ–¹å¼æ˜¯ä¸€ä¸ªé€šç”¨æ–¹æ³•ï¼Œå¯ä»¥è¿è¡Œä»»ä½• workflowï¼Œç›®å‰å¸¸ç”¨çš„ä¸»è¦æ˜¯ train å’Œ valã€‚</p>
<ul>
<li>å½“é…ç½®ä¸ºï¼šworkflow = [(&lsquo;train&rsquo;, 1)]ï¼Œè¡¨ç¤ºä»…ä»…è¿›è¡Œ train workflowï¼Œä¹Ÿå°±æ˜¯è¿­ä»£è®­ç»ƒ</li>
<li>å½“é…ç½®ä¸ºï¼šworkflow = [(&lsquo;train&rsquo;, n),(&lsquo;val&rsquo;, 1)]ï¼Œè¡¨ç¤ºå…ˆè¿›è¡Œ n ä¸ª epoch çš„è®­ç»ƒï¼Œç„¶åå†è¿›è¡Œ1ä¸ª epoch çš„éªŒè¯ï¼Œç„¶åå¾ªç¯å¾€å¤,å¦‚æœå†™æˆ [(&lsquo;val&rsquo;, 1),(&lsquo;train&rsquo;, n)] è¡¨ç¤ºå…ˆè¿›è¡ŒéªŒè¯ï¼Œç„¶åæ‰å¼€å§‹è®­ç»ƒ</li>
</ul>
<p>å½“è¿›å…¥å¯¹åº”çš„ workflowï¼Œåˆ™ä¼šè°ƒç”¨ runner é‡Œé¢çš„ train() æˆ–è€… val()ï¼Œè¡¨ç¤ºè¿›è¡Œä¸€æ¬¡ epoch è¿­ä»£ã€‚å…¶ä»£ç ä¹Ÿéå¸¸ç®€å•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">train</span>(self, data_loader, <span style="color:#666">**</span>kwargs):
    self<span style="color:#666">.</span>model<span style="color:#666">.</span>train()
    self<span style="color:#666">.</span>mode <span style="color:#666">=</span> <span style="color:#b44">&#39;train&#39;</span>
    self<span style="color:#666">.</span>data_loader <span style="color:#666">=</span> data_loader
    self<span style="color:#666">.</span>call_hook(<span style="color:#b44">&#39;before_train_epoch&#39;</span>)
    <span style="color:#a2f;font-weight:bold">for</span> i, data_batch <span style="color:#a2f;font-weight:bold">in</span> <span style="color:#a2f">enumerate</span>(self<span style="color:#666">.</span>data_loader):
        self<span style="color:#666">.</span>call_hook(<span style="color:#b44">&#39;before_train_iter&#39;</span>)
        self<span style="color:#666">.</span>run_iter(data_batch, train_mode<span style="color:#666">=</span>True)
        self<span style="color:#666">.</span>call_hook(<span style="color:#b44">&#39;after_train_iter&#39;</span>)

    self<span style="color:#666">.</span>call_hook(<span style="color:#b44">&#39;after_train_epoch&#39;</span>)


<span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">val</span>(self, data_loader, <span style="color:#666">**</span>kwargs):
    self<span style="color:#666">.</span>model<span style="color:#666">.</span>eval()
    self<span style="color:#666">.</span>mode <span style="color:#666">=</span> <span style="color:#b44">&#39;val&#39;</span>
    self<span style="color:#666">.</span>data_loader <span style="color:#666">=</span> data_loader
    self<span style="color:#666">.</span>call_hook(<span style="color:#b44">&#39;before_val_epoch&#39;</span>)
    <span style="color:#a2f;font-weight:bold">for</span> i, data_batch <span style="color:#a2f;font-weight:bold">in</span> <span style="color:#a2f">enumerate</span>(self<span style="color:#666">.</span>data_loader):
        self<span style="color:#666">.</span>call_hook(<span style="color:#b44">&#39;before_val_iter&#39;</span>)
        <span style="color:#a2f;font-weight:bold">with</span> torch<span style="color:#666">.</span>no_grad():
            self<span style="color:#666">.</span>run_iter(data_batch, train_mode<span style="color:#666">=</span>False)
        self<span style="color:#666">.</span>call_hook(<span style="color:#b44">&#39;after_val_iter&#39;</span>)
    self<span style="color:#666">.</span>call_hook(<span style="color:#b44">&#39;after_val_epoch&#39;</span>)
</code></pre></div><p>æ ¸å¿ƒå‡½æ•°å®é™…ä¸Šæ˜¯ self.run_iter()ï¼Œå¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">run_iter</span>(self, data_batch, train_mode, <span style="color:#666">**</span>kwargs):
    <span style="color:#a2f;font-weight:bold">if</span> train_mode:
        <span style="color:#080;font-style:italic"># å¯¹äºæ¯æ¬¡è¿­ä»£ï¼Œæœ€ç»ˆæ˜¯è°ƒç”¨å¦‚ä¸‹å‡½æ•°</span>
        outputs <span style="color:#666">=</span> self<span style="color:#666">.</span>model<span style="color:#666">.</span>train_step(data_batch,<span style="color:#666">...</span>)
    <span style="color:#a2f;font-weight:bold">else</span>:
        <span style="color:#080;font-style:italic"># å¯¹äºæ¯æ¬¡è¿­ä»£ï¼Œæœ€ç»ˆæ˜¯è°ƒç”¨å¦‚ä¸‹å‡½æ•°</span>
        outputs <span style="color:#666">=</span> self<span style="color:#666">.</span>model<span style="color:#666">.</span>val_step(data_batch,<span style="color:#666">...</span>)

    <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#b44">&#39;log_vars&#39;</span> <span style="color:#a2f;font-weight:bold">in</span> outputs:
        self<span style="color:#666">.</span>log_buffer<span style="color:#666">.</span>update(outputs[<span style="color:#b44">&#39;log_vars&#39;</span>],<span style="color:#666">...</span>)
    self<span style="color:#666">.</span>outputs <span style="color:#666">=</span> outputs
</code></pre></div><p>ä¸Šè¿° self.call_hook() è¡¨ç¤ºåœ¨ä¸åŒç”Ÿå‘½å‘¨æœŸè°ƒç”¨æ‰€æœ‰å·²ç»æ³¨å†Œè¿›å»çš„ hookï¼Œè€Œå­—ç¬¦ä¸²å‚æ•°è¡¨ç¤ºå¯¹åº”çš„ç”Ÿå‘½å‘¨æœŸã€‚ä»¥ OptimizerHook ä¸ºä¾‹ï¼Œå…¶æ‰§è¡Œåå‘ä¼ æ’­ã€æ¢¯åº¦è£å‰ªå’Œå‚æ•°æ›´æ–°ç­‰æ ¸å¿ƒè®­ç»ƒåŠŸèƒ½ï¼š</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#a2f">@HOOKS.register_module</span>()
<span style="color:#a2f;font-weight:bold">class</span> <span style="color:#00f">OptimizerHook</span>(Hook):

    <span style="color:#a2f;font-weight:bold">def</span> __init__(self, grad_clip<span style="color:#666">=</span>None):
        self<span style="color:#666">.</span>grad_clip <span style="color:#666">=</span> grad_clip

    <span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">after_train_iter</span>(self, runner):
        runner<span style="color:#666">.</span>optimizer<span style="color:#666">.</span>zero_grad()
        runner<span style="color:#666">.</span>outputs[<span style="color:#b44">&#39;loss&#39;</span>]<span style="color:#666">.</span>backward()
        <span style="color:#a2f;font-weight:bold">if</span> self<span style="color:#666">.</span>grad_clip <span style="color:#a2f;font-weight:bold">is</span> <span style="color:#a2f;font-weight:bold">not</span> None:
            grad_norm <span style="color:#666">=</span> self<span style="color:#666">.</span>clip_grads(runner<span style="color:#666">.</span>model<span style="color:#666">.</span>parameters())
        runner<span style="color:#666">.</span>optimizer<span style="color:#666">.</span>step()
</code></pre></div><p>å¯ä»¥å‘ç° OptimizerHook æ³¨å†Œåˆ°çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ after_train_iterï¼Œæ•…åœ¨æ¯æ¬¡ train() é‡Œé¢è¿è¡Œåˆ° <code>self.call_hook('after_val_iter')</code> æ—¶å€™å°±ä¼šè¢«è°ƒç”¨ï¼Œå…¶ä»– hook ä¹Ÿæ˜¯åŒæ ·è¿è¡Œé€»è¾‘ã€‚</p>
<h2 id="model">Model</h2>
<p>å‰é¢è¯´ä¸ªï¼Œè®­ç»ƒå’ŒéªŒè¯çš„æ—¶å€™å®é™…ä¸Šè°ƒç”¨äº† model å†…éƒ¨çš„ <code>train_step</code> å’Œ <code>val_step</code> å‡½æ•°ï¼Œ<strong>ç†è§£äº†ä¸¤ä¸ªå‡½æ•°è°ƒç”¨æµç¨‹å°±ç†è§£äº† MMDetection è®­ç»ƒå’Œæµ‹è¯•æµç¨‹</strong>ã€‚</p>
<p>æ³¨æ„ï¼Œç”±äº model å¯¹è±¡ä¼šè¢« DataParallel ç±»åŒ…è£¹ï¼Œæ•…å®é™…ä¸Šä¸Šæ­¤æ—¶çš„ modelï¼Œæ˜¯æŒ‡çš„ MMDataParallel æˆ–è€… MMDistributedDataParallelã€‚ä»¥éåˆ†å¸ƒå¼ train_step æµç¨‹ä¸ºä¾‹ï¼Œå…¶å†…éƒ¨å®Œæˆè°ƒç”¨æµç¨‹å›¾ç¤ºå¦‚ä¸‹ï¼š</p>
<div align=center>
<img src="/img/20220116132200.jpg" width="600px"/>
</div>
<h2 id="train--val">Train &amp; Val</h2>
<p><strong>(1) è°ƒç”¨ runner ä¸­çš„ <code>train_step</code> æˆ–è€… <code>val_step</code></strong></p>
<p>åœ¨ runner ä¸­è°ƒç”¨ <code>train_step</code> æˆ–è€… <code>val_step</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#080;font-style:italic">#=================== mmcv/runner/epoch_based_runner.py ==================</span>
<span style="color:#a2f;font-weight:bold">if</span> train_mode:
    outputs <span style="color:#666">=</span> self<span style="color:#666">.</span>model<span style="color:#666">.</span>train_step(data_batch,<span style="color:#666">...</span>)
<span style="color:#a2f;font-weight:bold">else</span>:
    outputs <span style="color:#666">=</span> self<span style="color:#666">.</span>model<span style="color:#666">.</span>val_step(data_batch,<span style="color:#666">...</span>)
</code></pre></div><p>å®é™…ä¸Šï¼Œé¦–å…ˆä¼šè°ƒç”¨ DataParallel ä¸­çš„ <code>train_step</code> æˆ–è€… <code>val_step</code> ï¼Œå…¶å…·ä½“è°ƒç”¨æµç¨‹ä¸ºï¼š</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#080;font-style:italic"># éåˆ†å¸ƒå¼è®­ç»ƒ</span>
<span style="color:#080;font-style:italic">#=================== mmcv/parallel/data_parallel.py/MMDataParallel ==================</span>
<span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">train_step</span>(self, <span style="color:#666">*</span>inputs, <span style="color:#666">**</span>kwargs):
    <span style="color:#a2f;font-weight:bold">if</span> <span style="color:#a2f;font-weight:bold">not</span> self<span style="color:#666">.</span>device_ids:
        inputs, kwargs <span style="color:#666">=</span> self<span style="color:#666">.</span>scatter(inputs, kwargs, [<span style="color:#666">-</span><span style="color:#666">1</span>])
        <span style="color:#080;font-style:italic"># æ­¤æ—¶æ‰æ˜¯è°ƒç”¨ model æœ¬èº«çš„ train_step</span>
        <span style="color:#a2f;font-weight:bold">return</span> self<span style="color:#666">.</span>module<span style="color:#666">.</span>train_step(<span style="color:#666">*</span>inputs, <span style="color:#666">**</span>kwargs)
    <span style="color:#080;font-style:italic"># å• gpu æ¨¡å¼</span>
    inputs, kwargs <span style="color:#666">=</span> self<span style="color:#666">.</span>scatter(inputs, kwargs, self<span style="color:#666">.</span>device_ids)
    <span style="color:#080;font-style:italic"># æ­¤æ—¶æ‰æ˜¯è°ƒç”¨ model æœ¬èº«çš„ train_step</span>
    <span style="color:#a2f;font-weight:bold">return</span> self<span style="color:#666">.</span>module<span style="color:#666">.</span>train_step(<span style="color:#666">*</span>inputs[<span style="color:#666">0</span>], <span style="color:#666">**</span>kwargs[<span style="color:#666">0</span>])

<span style="color:#080;font-style:italic"># val_step ä¹Ÿæ˜¯çš„ä¸€æ ·é€»è¾‘</span>
<span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">val_step</span>(self, <span style="color:#666">*</span>inputs, <span style="color:#666">**</span>kwargs):
    inputs, kwargs <span style="color:#666">=</span> self<span style="color:#666">.</span>scatter(inputs, kwargs, self<span style="color:#666">.</span>device_ids)
    <span style="color:#080;font-style:italic"># æ­¤æ—¶æ‰æ˜¯è°ƒç”¨ model æœ¬èº«çš„ val_step</span>
    <span style="color:#a2f;font-weight:bold">return</span> self<span style="color:#666">.</span>module<span style="color:#666">.</span>val_step(<span style="color:#666">*</span>inputs[<span style="color:#666">0</span>], <span style="color:#666">**</span>kwargs[<span style="color:#666">0</span>])
</code></pre></div><p>å¯ä»¥å‘ç°ï¼Œåœ¨è°ƒç”¨ model æœ¬èº«çš„ train_step å‰ï¼Œéœ€è¦é¢å¤–è°ƒç”¨ scatter å‡½æ•°ï¼Œå‰é¢è¯´è¿‡è¯¥å‡½æ•°çš„ä½œç”¨æ˜¯å¤„ç† DataContainer æ ¼å¼æ•°æ®ï¼Œä½¿å…¶èƒ½å¤Ÿç»„æˆ batchï¼Œå¦åˆ™ç¨‹åºä¼šæŠ¥é”™ã€‚</p>
<p>å¦‚æœæ˜¯åˆ†å¸ƒå¼è®­ç»ƒï¼Œåˆ™è°ƒç”¨çš„å®é™…ä¸Šæ˜¯ <code>mmcv/parallel/distributed.py/MMDistributedDataParallel</code>ï¼Œæœ€ç»ˆè°ƒç”¨çš„ä¾ç„¶æ˜¯ model æœ¬èº«çš„ <code>train_step</code> æˆ–è€… <code>val_step</code>ã€‚</p>
<p><strong>(2) è°ƒç”¨ model ä¸­çš„ <code>train_step</code> æˆ–è€… <code>val_step</code></strong></p>
<p>å…¶æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#080;font-style:italic">#=================== mmdet/models/detectors/base.py/BaseDetector ==================</span>
<span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">train_step</span>(self, data, optimizer):
    <span style="color:#080;font-style:italic"># è°ƒç”¨æœ¬ç±»è‡ªèº«çš„ forward æ–¹æ³•</span>
    losses <span style="color:#666">=</span> self(<span style="color:#666">**</span>data)
    <span style="color:#080;font-style:italic"># è§£æ loss</span>
    loss, log_vars <span style="color:#666">=</span> self<span style="color:#666">.</span>_parse_losses(losses)
    <span style="color:#080;font-style:italic"># è¿”å›å­—å…¸å¯¹è±¡</span>
    outputs <span style="color:#666">=</span> <span style="color:#a2f">dict</span>(
        loss<span style="color:#666">=</span>loss, log_vars<span style="color:#666">=</span>log_vars, num_samples<span style="color:#666">=</span><span style="color:#a2f">len</span>(data[<span style="color:#b44">&#39;img_metas&#39;</span>]))
    <span style="color:#a2f;font-weight:bold">return</span> outputs

<span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">forward</span>(self, img, img_metas, return_loss<span style="color:#666">=</span>True, <span style="color:#666">**</span>kwargs):
    <span style="color:#a2f;font-weight:bold">if</span> return_loss:
        <span style="color:#080;font-style:italic"># è®­ç»ƒæ¨¡å¼</span>
        <span style="color:#a2f;font-weight:bold">return</span> self<span style="color:#666">.</span>forward_train(img, img_metas, <span style="color:#666">**</span>kwargs)
    <span style="color:#a2f;font-weight:bold">else</span>:
        <span style="color:#080;font-style:italic"># æµ‹è¯•æ¨¡å¼</span>
        <span style="color:#a2f;font-weight:bold">return</span> self<span style="color:#666">.</span>forward_test(img, img_metas, <span style="color:#666">**</span>kwargs)
</code></pre></div><p><code>forward_train</code> å’Œ <code>forward_test</code> éœ€è¦åœ¨ä¸åŒçš„ç®—æ³•å­ç±»ä¸­å®ç°ï¼Œè¾“å‡ºæ˜¯ Loss æˆ–è€… é¢„æµ‹ç»“æœã€‚</p>
<p><strong>(3) è°ƒç”¨å­ç±»ä¸­çš„ <code>forward_train</code> æ–¹æ³•</strong></p>
<p>ç›®å‰æä¾›äº†ä¸¤ä¸ªå…·ä½“å­ç±»ï¼Œ<code>TwoStageDetector</code> å’Œ <code>SingleStageDetector</code> ï¼Œç”¨äºå®ç° two-stage å’Œ single-stage ç®—æ³•ã€‚</p>
<p>å¯¹äº <code>TwoStageDetector</code> è€Œè¨€ï¼Œå…¶æ ¸å¿ƒé€»è¾‘æ˜¯ï¼š</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#080;font-style:italic">#============= mmdet/models/detectors/two_stage.py/TwoStageDetector ============</span>
<span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">forward_train</span>(<span style="color:#666">...</span>):
    <span style="color:#080;font-style:italic"># å…ˆè¿›è¡Œ backbone+neck çš„ç‰¹å¾æå–</span>
    x <span style="color:#666">=</span> self<span style="color:#666">.</span>extract_feat(img)
    losses <span style="color:#666">=</span> <span style="color:#a2f">dict</span>()
    <span style="color:#080;font-style:italic"># RPN forward and loss</span>
    <span style="color:#a2f;font-weight:bold">if</span> self<span style="color:#666">.</span>with_rpn:
        <span style="color:#080;font-style:italic"># è®­ç»ƒ RPN</span>
        proposal_cfg <span style="color:#666">=</span> self<span style="color:#666">.</span>train_cfg<span style="color:#666">.</span>get(<span style="color:#b44">&#39;rpn_proposal&#39;</span>,
                                          self<span style="color:#666">.</span>test_cfg<span style="color:#666">.</span>rpn)
        <span style="color:#080;font-style:italic"># ä¸»è¦æ˜¯è°ƒç”¨ rpn_head å†…éƒ¨çš„ forward_train æ–¹æ³•</span>
        rpn_losses, proposal_list <span style="color:#666">=</span> self<span style="color:#666">.</span>rpn_head<span style="color:#666">.</span>forward_train(x,<span style="color:#666">...</span>)
        losses<span style="color:#666">.</span>update(rpn_losses)
    <span style="color:#a2f;font-weight:bold">else</span>:
        proposal_list <span style="color:#666">=</span> proposals
    <span style="color:#080;font-style:italic"># ç¬¬äºŒé˜¶æ®µï¼Œä¸»è¦æ˜¯è°ƒç”¨ roi_head å†…éƒ¨çš„ forward_train æ–¹æ³•</span>
    roi_losses <span style="color:#666">=</span> self<span style="color:#666">.</span>roi_head<span style="color:#666">.</span>forward_train(x, <span style="color:#666">...</span>)
    losses<span style="color:#666">.</span>update(roi_losses)
    <span style="color:#a2f;font-weight:bold">return</span> losses
</code></pre></div><p>å¯¹äº <code>SingleStageDetector</code> è€Œè¨€ï¼Œå…¶æ ¸å¿ƒé€»è¾‘æ˜¯ï¼š</p>
<div class="highlight"><pre style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#080;font-style:italic">#============= mmdet/models/detectors/single_stage.py/SingleStageDetector ============</span>
<span style="color:#a2f;font-weight:bold">def</span> <span style="color:#00a000">forward_train</span>(<span style="color:#666">...</span>):
    <span style="color:#a2f">super</span>(SingleStageDetector, self)<span style="color:#666">.</span>forward_train(img, img_metas)
    <span style="color:#080;font-style:italic"># å…ˆè¿›è¡Œ backbone+neck çš„ç‰¹å¾æå–</span>
    x <span style="color:#666">=</span> self<span style="color:#666">.</span>extract_feat(img)
    <span style="color:#080;font-style:italic"># ä¸»è¦æ˜¯è°ƒç”¨ bbox_head å†…éƒ¨çš„ forward_train æ–¹æ³•</span>
    losses <span style="color:#666">=</span> self<span style="color:#666">.</span>bbox_head<span style="color:#666">.</span>forward_train(x, <span style="color:#666">...</span>)
    <span style="color:#a2f;font-weight:bold">return</span> losses
</code></pre></div><p>å¦‚æœå†å¾€é‡Œåˆ†æï¼Œé‚£å°±åˆ°å„ä¸ª Head æ¨¡å—çš„è®­ç»ƒç¯èŠ‚äº†ï¼Œè¿™éƒ¨åˆ†å†…å®¹è¯·è¯»è€…è‡ªè¡Œåˆ†æï¼Œåº”è¯¥ä¸éš¾ã€‚</p>
<h2 id="test">Test</h2>
<p>ç”±äºæ²¡æœ‰ runner å¯¹è±¡ï¼Œæµ‹è¯•æµç¨‹ç®€å•å¾ˆå¤šï¼Œä¸‹é¢ç®€è¦æ¦‚è¿°ï¼š</p>
<ol>
<li>è°ƒç”¨ MMDataParallel æˆ– MMDistributedDataParallel ä¸­çš„ <code>forward</code> æ–¹æ³•</li>
<li>è°ƒç”¨ base.py ä¸­çš„ <code>forward</code> æ–¹æ³•</li>
<li>è°ƒç”¨ base.py ä¸­çš„ <code>self.forward_test</code> æ–¹æ³•</li>
<li>å¦‚æœæ˜¯å•å°ºåº¦æµ‹è¯•ï¼Œåˆ™ä¼šè°ƒç”¨ TwoStageDetector æˆ– SingleStageDetector ä¸­çš„ <code>simple_test</code> æ–¹æ³•ï¼Œå¦‚æœæ˜¯å¤šå°ºåº¦æµ‹è¯•ï¼Œåˆ™è°ƒç”¨ <code>aug_test</code> æ–¹æ³•</li>
<li>æœ€ç»ˆè°ƒç”¨çš„æ˜¯æ¯ä¸ªå…·ä½“ç®—æ³• Head æ¨¡å—çš„ <code>simple_test</code> æˆ–è€… <code>aug_test</code> æ–¹æ³•</li>
</ol>
<h1 id="conclusion">Conclusion</h1>
<p>æœ¬æ–‡ä»ä¸‰ä¸ªå±‚é¢å…¨é¢è§£è¯»äº† MMDetection æ¡†æ¶ï¼Œå¯¹ MMDetection æ¡†æ¶è®¾è®¡æ€æƒ³ã€ç»„ä»¶é—´å…³ç³»å’Œæ•´ä½“ä»£ç å®ç°æµç¨‹æœ‰ä¸€å®šçš„äº†è§£ã€‚</p>
<h1 id="reference">Reference</h1>
<ul>
<li>åŸæ–‡ï¼š<a href="https://zhuanlan.zhihu.com/p/341954021">è½»æ¾æŒæ¡ MMDetection æ•´ä½“æ„å»ºæµç¨‹</a></li>
</ul>

    
  </article>
  <div class="paginator">
    
    <a class="link" href="https://preminstrel.github.io/blog/post/2022/01/15/mmdetection-overview/">â† prev</a>
    
    
    <a class="link" href="https://preminstrel.github.io/blog/post/2022/01/17/mmdetection-head/">next â†’</a>
    
  </div>
  <div class="comment">
    
    
    
    
    
    
  </div>
  
</main>

    <footer id="footer">
  <div>
    <span>Â© 2021</span> - <span>2022</span>
  </div>

  <div>
    <span>Powered by </span>
    <a class="link" href="https://gohugo.io/">Hugo</a>
    <span> ğŸ¦ Theme </span>
    <a class="link" href="https://github.com/queensferryme/hugo-theme-texify">TeXify</a>
  </div>

  <div class="footnote">
    <span>Follow me on <a class=link href=https://github.com/preminstrel>GitHub</a>,
<a class=link href=https://twitter.com/preminstrel>Twitter</a> or
<a class=link href=/index.xml>RSS</a> |
<a class=link href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh target=_blank rel=noopener>CC BY-NC-SA 4.0</a>
</span>
  </div>
</footer>

  </div>

  
  

  
  

  
  

</body>

</html>
